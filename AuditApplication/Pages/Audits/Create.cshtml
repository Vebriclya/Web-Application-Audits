@page
@model AuditApplication.Pages.Audits.CreateModel

@{
    ViewData["Title"] = "Create";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

    <div id="templateSelection">
        <select id="templateDropdown" asp-items="@(new SelectList(Model.AvailableTemplates, "Id", "Name"))">
            <option>Select an audit template</option>
        </select>
        <button id="beginAudit" class="btn btn-primary">Begin</button>
    </div>
<div id="auditContent" style="display: none">
    
</div>

<div>
    <a asp-page="Index">Back to List</a>
</div>

@Html.AntiForgeryToken()
@section Scripts
{
    <script>
        $(document).ready(function () {
            $('#beginAudit').click(function () {
                var $dropdown = $('#templateDropdown');
                var templateId = parseInt($dropdown.val());

                if (templateId){
                    $.ajax({
                        url: '?handler=CreateAuditFromTemplate',
                        type: 'POST',
                        data: JSON.stringify({ templateId: templateId }),
                        contentType: 'application/json',
                        dataType: 'json',
                        headers: {
                            "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function (result){
                            if (result.success){
                                $('#templateSelection').hide();
                                $('#auditContent').html(result.auditHtml).show();
                            } else {
                                alert('Failed to create audit: ' + (result.message || "Please try again."));
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error("Error", xhr.responseText);
                            alert('An error occurred. Please try again.');
                        }
                    });
                } else {
                    alert('Please select a template.');
                }
});
        });
    </script>
}
