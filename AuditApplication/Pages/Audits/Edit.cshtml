@page
@model AuditApplication.Pages.Audits.EditModel

@{
    ViewData["Title"] = "Edit";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

<div class="row header-area m-0">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div class="col-2 text-start">
            <a asp-page="Index">&lt;--Back to List</a>
        </div>
        <div class="col-2"></div>
        <h3 id="auditTitle" class="col-6 text-center m-0">New Audit</h3>
        <div class="col-2 text-end"></div>
    </div>
</div>

<div class="row g-0">
    <div class="col-3 left-sidebar">
        <ul class="list-group" id="sectionList">
            <!-- Do not fret, population lies here -->
        </ul>
    </div>
    <div class="col-9 right-content">
        <div id="sectionDetails" class="mt-4" style="display: none;">
            <!-- I, too, shall be populated -->
        </div>
    </div>
</div>

@Html.AntiForgeryToken()
@section Scripts
{
    <script>
    $(document).ready(function () {
        var auditData = @Json.Serialize(new
                        {
                            id = Model.Audit.Id,
                            name = Model.Audit.AuditName,
                            sections = Model.Audit.Sections.Select(s => new
                            {
                                id = s.Id,
                                name = s.Name,
                                order = s.Order
                            })
                        });
            
        var sectionListHtml = generateSectionListHtml(@Html.Raw(Json.Serialize(Model.Audit.Sections.Select(s => new { s.Id, s.Name, s.Order }))));
        $('#sectionList').html(sectionListHtml);

        $('#auditTitle').text('@Model.Audit.AuditName').show();
        
        // you might not want these two bits
        var firstSection = @Json.Serialize(Model.Audit.Sections.FirstOrDefault());
        if (firstSection){
            var sectionDetailsHtml = generateSectionDetailsHtml(firstSection);
            $('#sectionDetails').html(sectionDetailsHtml).show();
        }
        
        
        // Changing responses (think radio)
        $(document).on('change', '.response-options input[type="radio"]', function() {
            var questionId = $(this).closest('.question').data('question-id');
            var response = $(this).val();
            saveQuestionResponse(questionId, response);
        });

        function saveQuestionResponse(questionId, response) {
            var auditId = @Model.Audit.Id;
            var scoreValue = {
                'Excellent': 100,
                'Good': 75,
                'RequiresImprovement': 50,
                'Poor': 25,
                'NotAssessed': 0
            }[response];

            var requestData = {
                questionId: questionId,
                auditId: auditId,
                response: scoreValue
            };
            
            var textAnswerInput = $(`#textAnswer-${questionId}`);
            if (textAnswerInput.length && textAnswerInput.val() !== "") {
                requestData.textAnswer = textAnswerInput.val();
            }

            console.log('Saving response:', requestData);

            $.ajax({
                url: '?handler=UpdateQuestionResponse',
                type: 'POST',
                data: JSON.stringify(requestData),
                contentType: 'application/json',
                headers: {
                    "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(result) {
                    console.log('Success response:', result);
                    if (result.success) {
                        console.log('Response saved successfully');
                        $(`input[name='response-${questionId}'][value='${response}']`).prop('checked', true);
                    } else {
                        console.error('Failed to save response:', result.message);
                        alert('Failed to save response: ' + result.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Error status:', status);
                    console.log('Error thrown:', error);
                    console.log('Response text:', xhr.responseText);
                    try {
                        var jsonResponse = JSON.parse(xhr.responseText);
                        console.log('Parsed error response:', jsonResponse);
                    } catch (e) {
                        console.log('Could not parse error response as JSON');
                    }
                    alert('Failed to save response. Please check the console for more details.');
                }
            });
        }
        
        
        // Editing sections
        $(document).on('click', '.edit-section', function (e){
            e.preventDefault();
            var sectionId = $(this).closest('.section').data('section-id');
            var newText = prompt("Enter new section text:");
            if (newText){
                updateSection(sectionId, newText);
            }
        });
        
        function updateSection(sectionId, newName) {
            $.ajax({
                url: '?handler=UpdateSection',
                type: 'POST',
                data: JSON.stringify({ id: sectionId, name: newName }),
                contentType: 'application/json',
                headers: {
                    "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(result) {
                    if (result.success) {
                        console.log('Section updated successfully');
                    } else {
                        console.error('Failed to update section');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error updating section:', error);
                    alert('Error updating section, see dev console');
                }
            });
        }
        
        //Editing questions
        $(document).on('click', '.edit-question', function(e){
            e.preventDefault();
            var questionId = $(this).closest('.question').data('question-id');
            var newText = prompt("Enter new question text:");
            if (newText){
                updateQuestion(questionId, newText);
            }
        });
        
        function updateQuestion(questionId, newText) {
            $.ajax({
                url: '?handler=UpdateQuestion',
                type: 'POST',
                data: JSON.stringify({ id: questionId, text: newText }),
                contentType: 'application/json',
                headers: {
                    "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(result) {
                    if (result.success) {
                        console.log('Question updated successfully');
                    } else {
                        console.error('Failed to update question');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error updating question:', error);
                    alert('Error updating question, see dev console');
                }
            });
        }

        $(document).on('click', '.delete-question', function(e) {
            e.preventDefault();
            if (confirm('Are you sure you want to delete this question?')) {
                var questionId = $(this).closest('.question').data('question-id');
                deleteQuestion(questionId);
            }
        });

        function deleteQuestion(questionId) {
            $.ajax({
                url: '?handler=DeleteQuestion',
                type: 'POST',
                data: JSON.stringify(questionId),
                contentType: 'application/json',
                headers: {
                    "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(result) {
                    if (result.success) {
                        $(`[data-question-id="${questionId}"]`).remove();
                        console.log('Question deleted successfully');
                    } else {
                        console.error('Failed to delete question');
                        alert('Failed to delete question. Please try again.');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error deleting question:', error);
                    alert('Error deleting question, see dev console');
                }
            });
        }
        
        
        
        // Section List stuff (left hand side)
        function generateSectionListHtml(sections) {
            var html = '';
            sections.forEach(function(section) {
                html += `<li class='list-group-item' data-section-id='${section.id}'><span class='section-text'>${section.name}</span></li>`;
            });
            return html;
        }
        
        $(document).on('click', '#sectionList li', function () {
            var sectionId = $(this).data('section-id');

            $('#sectionList li').removeClass('active');
            $(this).addClass('active');

            $.ajax({
                url: '?handler=SectionDetails',
                type: 'GET',
                data: { sectionId: sectionId },
                success: function (result) {
                    if (result.sectionDetailsHtml) {
                        $('#sectionDetails').html(result.sectionDetailsHtml);
                        applyQuestionHandlers();
                    } else {
                        console.error("No sectionDetailsHtml in result");
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error loading section details:", error);
                    alert("Error loading section details, see dev console.");
                }
            });
        });
        
        function applyQuestionHandlers() {
            $('.response-options input[type="radio"]').off('change').on('change', function() {
                var questionId = $(this).closest('.question').data('question-id');
                var response = $(this).val();
                saveQuestionResponse(questionId, response);
            });

            $('.save-comment').on('click', function() {
                var questionId = $(this).closest('.question').data('question-id');
                var comment = $(this).siblings('.comment-text').val();
                saveQuestionComment(questionId, comment);
            });
        }
        
        
        // Section Detail Stuff (right hand side)
        function generateSectionDetailsHtml(section) {
            var html = `<div class='section' data-section-id='${section.id}' data-audit-id='${section.auditId}'>
            <div class='text-center mb-4'>
                <h4 class='section-name'>${section.name}</h4>
            </div>
            <div class='questions'>`;

            section.questions.forEach(function(question, index) {
                html += generateQuestionHtml(question, index + 1);
            });

            html += `</div></div>`;
            return html;
        }

        function generateQuestionHtml(question, questionNumber) {
            var html = `<div class='question mb-3 pb-3 border-bottom' data-question-id='${question.id}'>
            <div class='d-flex justify-content-between align-items-center'>
                <h5 class='question-text mb-0'>${question.text}</h5>
                <div>
                    <a href='#' class='edit-question me-2'>Edit</a>
                    <a href='#' class='delete-question'>Delete</a>
                </div>
            </div>`;

            html += generateRadioButtons(question);
            html += generateAttachmentAndCommentButtons();
            html += generateCommentsAccordion();

            html += `</div>`;
            return html;
        }

        function generateRadioButtons(question) {
            var options = ['Excellent', 'Good', 'RequiresImprovement', 'Poor', 'NotAssessed'];
            var html = `<div class='response-options'>`;
            options.forEach(function(option) {
                var displayText = option === 'RequiresImprovement' ? 'Requires Improvement' :
                    option === 'NotAssessed' ? 'Not Assessed' : option;
                var checked = question.response === option ? 'checked' : '';
                html += `<div class='form-check form-check-inline'>
                <input class='form-check-input' type='radio' name='response-${question.id}' 
                    id='response-${question.id}-${option}' value='${option}' ${checked}>
                <label class='form-check-label' for='response-${question.id}-${option}'>${displayText}</label>
            </div>`;
            });
            html += `</div>`;
            return html;
        }

        function generateCommentsAccordion() {
            return `<div class='comments-accordion mt-2' style='display: none;'>
                            <div class='card'>
                                <div class='card-body'>
                                    <textarea class='form-control comment-text' rows='3'></textarea>
                                    <button class='btn btn-primary btn-sm mt-2 save-comment'>Save</button>
                                </div>
                            </div>
                        </div>`;
        }

        function generateAttachmentAndCommentButtons() {
            return `<div class='mt-2 d-flex justify-content-end'>
                            <button class='btn btn-secondary btn-sm attachments-btn me-2'>Attachments</button>
                            <button class='btn btn-secondary btn-sm comments-btn'>Comments</button>
                        </div>`;
        }

        $(document).on('click', '.comments-btn', function() {
            $(this).closest('.question').find('.comments-accordion').toggle();
        });

        $(document).on('click', '.attachments-btn', function() {
            alert('Attachment functionality coming soon!');
        });

        $(document).ready(function() {
            // Fetch saved responses and update UI
            $.ajax({
                url: '?handler=SavedResponses',
                type: 'GET',
                success: function(result) {
                    if (result.success) {
                        result.responses.forEach(function(response) {
                            var radioValue;
                            switch(response.radioAnswer) {
                                case 100: radioValue = 'Excellent'; break;
                                case 75: radioValue = 'Good'; break;
                                case 50: radioValue = 'RequiresImprovement'; break;
                                case 25: radioValue = 'Poor'; break;
                                case 0: radioValue = 'NotAssessed'; break;
                            }
                            $(`input[name='response-${response.questionId}'][value='${radioValue}']`).prop('checked', true);

                            // If you have text inputs for answers, update those too
                            if (response.textAnswer) {
                                $(`#textAnswer-${response.questionId}`).val(response.textAnswer);
                            }
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading saved responses:', error);
                }
            });
        });
    });
</script>
}
